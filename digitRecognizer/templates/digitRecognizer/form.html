{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  </head>
  <body onload="InitThis();">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <div class="container">
      <h2>Steps</h2>
      <ul><li>Draw the digit</li><li>Save</li><li>Upload and Submit</li></ul>
    </div>
    <div align="center">
        <canvas id="myCanvas" width="200" height="200" style="border:2px solid black"></canvas>
        <br /><br />
        <a href="#" class="button" id="btn-download" download="my-file-name.png">Download</a>
        <!-- <a href="#" class="button" id="btn-download">Download</a> -->
<!--         <button onclick="javascript:clearArea();return false;">Clear Area</button>
        <button onclick="javascript:save();">Save</button> -->
        <select id="selWidth" style="display: none;">
            <option value="11" selected="selected">11</option>
        </select>
        <select id="selColor" style="display: none;">
            <option value="black" selected="selected" style="display: none;">black</option>
        </select>
    </div>

  {% if messages %}
      {% for msg in messages %}       
            <div class="alert alert-{{msg.level_tag}}" role="alert">
          <p>{{msg.message}}</p>
        </div>
      {% endfor %}
  </ul>
  {% endif %}
  
  {% block content %}
      <h1>{{ h1Text }}</h1>
      <div class="container">
      <form method="POST" enctype="multipart/form-data">{% csrf_token %}
          {{ form.as_p }}
          <button type="submit" class="save btn btn-default">Submit</button>
      </form>
      </div>
  {% endblock %}
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  </body>
      <script type="text/javascript">
      var mousePressed = false;
      var lastX, lastY;
      var ctx;
      var canvas = document.getElementById('myCanvas');
      function InitThis() {
          ctx = document.getElementById('myCanvas').getContext("2d");
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          $('#myCanvas').mousedown(function (e) {
              mousePressed = true;
              Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
          });

          $('#myCanvas').mousemove(function (e) {
              if (mousePressed) {
                  Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
              }
          });

          $('#myCanvas').mouseup(function (e) {
              mousePressed = false;
          });
            $('#myCanvas').mouseleave(function (e) {
              mousePressed = false;
          });

      }
      canvas.addEventListener("touchstart", function (e) {
      mousePos = getTouchPos(canvas, e);
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent("mousedown", {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }, false);
    canvas.addEventListener("touchend", function (e) {
      var mouseEvent = new MouseEvent("mouseup", {});
      canvas.dispatchEvent(mouseEvent);
    }, false);
    canvas.addEventListener("touchmove", function (e) {
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent("mousemove", {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }, false);
    // Get the position of a touch relative to the canvas
    function getTouchPos(canvasDom, touchEvent) {
      var rect = canvasDom.getBoundingClientRect();
      return {
        x: touchEvent.touches[0].clientX - rect.left,
        y: touchEvent.touches[0].clientY - rect.top
      };
    }
        // Prevent scrolling when touching the canvas
    document.body.addEventListener("touchstart", function (e) {
      if (e.target == canvas) {
        e.preventDefault();
      }
    }, false);
    document.body.addEventListener("touchend", function (e) {
      if (e.target == canvas) {
        e.preventDefault();
      }
    }, false);
    document.body.addEventListener("touchmove", function (e) {
      if (e.target == canvas) {
        e.preventDefault();
      }
    }, false);

      function Draw(x, y, isDown) {
          if (isDown) {
              ctx.beginPath();
              ctx.strokeStyle = $('#selColor').val();
              ctx.lineWidth = $('#selWidth').val();
              ctx.lineJoin = "round";
              ctx.moveTo(lastX, lastY);
              ctx.lineTo(x, y);
              ctx.closePath();
              ctx.stroke();
          }
          lastX = x; lastY = y;
      }
        
      function clearArea() {
          // Use the identity matrix while clearing the canvas
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = 'black';
      }
      function save(){
        var dataURL = document.getElementById('myCanvas').toDataURL();
        //document.getElementById('id_image').value = dataURL;
        this.href = dataURL;
        this.download = 'test.png'
      }
      function downloadCanvas(link, canvasId, filename) {
          link.href = document.getElementById(canvasId).toDataURL();
          link.download = filename;
      }
      $("#btn-download").click(function() {
          downloadCanvas(this, 'myCanvas', 'test.png');
      });
    </script>
</html>